#!/usr/local/bin/python3
import requests
import sys
from bs4 import BeautifulSoup
import json
import math

shardcount=2240

def ide(shardcount):
    guild_ID=sys.argv[1]
    url_combined = str("https://web.rythmbot.co/ajax/shard/" + guild_ID)
    page = requests.get(url_combined)
    python_obj = json.loads(page.text)
    shard_ID=int(python_obj["shard"])
    cluster_ID=int(python_obj["cluster"])
    print(f"\nshard:\t\t{shard_ID}\ncluster:\t{cluster_ID}\n")
    rawstat = requests.get("https://status.rythmbot.co/raw")
    print(f"{shard_ID}:", json.loads(rawstat.text)[str(shard_ID)])

def status(shardcount):
    onlinecount=0
    initi=[]
    initd=[]
    log=[]
    webs=[]
    ident=[]
    awaiting=[]
    load=[]
    recon=[]
    attempt=[]
    waitcon=[]
    queue=[]
    rawstat = requests.get("https://status.rythmbot.co/raw")
    raw=json.loads(rawstat.text)
    for i in raw:
        if raw[str(i)]=="CONNECTED":
            onlinecount=onlinecount+1
        elif raw[str(i)]=="INITIALIZING":
            initi.append(str(i))
        elif raw[str(i)]=="INITIALIZED":
            initd.append(str(i))
        elif raw[str(i)]=="LOGGING_IN":
            log.append(str(i))
        elif raw[str(i)]=="CONNECTING_TO_WEBSOCKET":
            webs.append(str(i))
        elif raw[str(i)]=="IDENTIFYING_SESSION":
            ident.append(str(i))
        elif raw[str(i)]=="AWAITING_LOGIN_CONFIRMATION":
            awaiting.append(str(i))
        elif raw[str(i)]=="LOADING_SUBSYSTEMS":
            load.append(str(i))
        elif raw[str(i)]=="RECONNECTING":
            recon.append(str(i))
        elif raw[str(i)]=="ATTEMPTING_TO_RECONNECT":
            attempt.append(str(i))
        elif raw[str(i)]=="WAITING_TO_RECONNECT":
            waitcon.append(str(i))
        elif raw[str(i)]=="RECONNECT_QUEUED":
            queue.append(str(i))
    if onlinecount==shardcount:
        print("Rythm is fully operational!")
        print("-----------------------------")
        print(onlinecount, "\t Online")
    else:
        print("Rythm is ", round(((onlinecount)/shardcount), 1)*100, "% online")
        print("------------------------------")
        print(onlinecount, "\t Online")
        problems=shardcount-onlinecount
        print("------------------------------")
        print("Count\t Status\t\t\t Shards\n")
        print(problems, "\t Shards with issues")
        print(len(queue), "\t In reconnect queue\t", getstr(queue))
        print(len(waitcon), "\t Waiting to reconnect\t", getstr(waitcon))
        print(len(load), "\t Loading subsystems\t", getstr(load))
        print(len(awaiting), "\t Awaiting confirmation\t", getstr(awaiting))
        print(len(initi), "\t Initialising\t\t", getstr(initi))
        print(len(initd), "\t Initialised\t\t", getstr(initd))
        print(len(log), "\t Logging in\t\t", getstr(log))
        print(len(webs), "\t Connecting to websocket", getstr(webs))
        print(len(ident), "\t Identifying\t\t", getstr(ident))
        print(len(recon), "\t Reconnecting\t\t", getstr(recon))
        print(len(attempt), "\t Attempting to reconnect", getstr(attempt))


def getstr(arre):
    if len(arre)>5:
        return "..."
    elif len(arre)==0:
        return ""
    else:
        arre_s=">"
        for i in arre:
            arre_s=arre_s+i+", "
        return arre_s

def shard(shardcount):
    shard_ID=sys.argv[2]
    print("shard:\t\t", shard_ID)
    print("cluster:\t", math.floor(int(shard_ID)/int(math.ceil(shardcount/9))))
    rawstat = requests.get("https://status.rythmbot.co/raw")
    print("status:\t\t", json.loads(rawstat.text)[str(shard_ID)])


if sys.argv[1] == "h":
    print("ry cli help\nry h\t\tdisplays this help command\nry <guild>\tshows the shard, cluster, and status for a guild\nry f <shard>\tshows the cluster and status for a shard\nry s\t\tshows the full status for rythm")
elif sys.argv[1] == "s":
    status(shardcount)
elif sys.argv[1] == "status":
    status(shardcount)
elif sys.argv[1] == "shard":
    shard(shardcount)
elif sys.argv[1] == "f":
    shard(shardcount)
else:
    ide(shardcount)
